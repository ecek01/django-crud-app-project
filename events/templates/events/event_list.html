{% extends 'base.html' %}

{% block content %}
<div style="display: flex;">
    <!-- Left: Calendar -->
    <div style="width: 60%;">
        <div id="calendar"></div>
    </div>

    <!-- Right: Event Details & Actions -->
    <div style="width: 40%; padding: 20px;">
        <h2>Event Actions</h2>
        <div id="event-form">
            <p>Select a date on the calendar to add an event.</p>
        </div>
    </div>
</div>

<!-- FullCalendar Initialization Script -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        var calendarEl = document.getElementById('calendar');
    
        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            selectable: true,
            events: '/events/api/',  // Fetch events from Django
    
            // Handle clicking on an empty date to add an event
            dateClick: function(info) {
                showEventForm(info.dateStr);
            },
    
            // Handle clicking on an existing event to show details (not editable yet)
            eventClick: function(info) {
                showEventDetails(info.event);
            }
        });
    
        calendar.render();
    });
    
    // Function to show event creation form when clicking a date
    function showEventForm(date) {
        document.getElementById('event-form').innerHTML = `
            <h3>Add Event on ${date}</h3>
            <form method="POST" action="{% url 'event_create' %}">
                {% csrf_token %}
                <input type="hidden" name="date" value="${date}">
                <label>Title:</label><br>
                <input type="text" name="title" required><br>
                <label>Time:</label><br>
                <input type="time" name="time" required><br>
                <label>Priority:</label><br>
                <select name="priority">
                    <option value="High">High</option>
                    <option value="Medium">Medium</option>
                    <option value="Low">Low</option>
                </select><br>
                <label>Notes:</label><br>
                <textarea name="notes" rows="3" cols="40"></textarea><br><br>
                <button type="submit">Save</button>
            </form>
        `;
    }
    
    // Function to show event details (without editing)
    function showEventDetails(event) {
    document.getElementById('event-form').innerHTML = `
        <h3>${event.title}</h3>
        <p><strong>Date:</strong> ${event.start}</p>
        <p><strong>Time:</strong> ${event.extendedProps.time}</p>
        <p><strong>Priority:</strong> ${event.extendedProps.priority}</p>
        <p><strong>Notes:</strong> ${event.extendedProps.notes || 'No notes added'}</p>
        <a href="/events/${event.id}/edit/"><button>Edit</button></a>  <!-- ✅ Takes user to edit page -->
        <form method="POST" action="/events/${event.id}/delete/" style="margin-top: 10px;">
            {% csrf_token %}
            <button type="submit" style="background-color: red; color: white;">Delete</button>
        </form>
    `;
}

    
    // Function to enable editing when clicking "Edit"
    function enableEditing(id, title, date, time, priority, notes) {
    document.getElementById('event-form').innerHTML = `
        <h3>Edit Event</h3>
        <form id="edit-event-form">
            {% csrf_token %}
            <input type="hidden" name="event_id" value="${id}">
            <label>Title:</label><br>
            <input type="text" id="edit-title" name="title" value="${title}" required><br>
            <label>Date:</label><br>
            <input type="date" id="edit-date" name="date" value="${date}" required><br>  <!-- ✅ Added date field -->
            <label>Time:</label><br>
            <input type="time" id="edit-time" name="time" value="${time}" required><br>
            <label>Priority:</label><br>
            <select id="edit-priority" name="priority">
                <option value="High" ${priority === "High" ? "selected" : ""}>High</option>
                <option value="Medium" ${priority === "Medium" ? "selected" : ""}>Medium</option>
                <option value="Low" ${priority === "Low" ? "selected" : ""}>Low</option>
            </select><br>
            <label>Notes:</label><br>
            <textarea id="edit-notes" name="notes" rows="3" cols="40">${notes}</textarea><br><br>
            <button type="button" onclick="submitEdit(${id})">Update</button>
            <button type="button" onclick="showEventDetails({id: ${id}, title: '${title}', start: '${date}', extendedProps: {time: '${time}', priority: '${priority}', notes: '${notes}'}})">Cancel</button>
        </form>
    `;
}

// Function to send the edited event data via AJAX
function submitEdit(eventId) {
    const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;  // Get CSRF token

    const formData = {
        'title': document.getElementById('edit-title').value,
        'time': document.getElementById('edit-time').value,
        'priority': document.getElementById('edit-priority').value,
        'notes': document.getElementById('edit-notes').value,
        'date': document.getElementById('edit-date').value  // ✅ Added missing date field
    };

    fetch(`/events/${eventId}/edit/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken  // Include CSRF token
        },
        body: JSON.stringify(formData)  // Send JSON
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            showEventDetails({
                id: eventId,
                title: formData.title,
                start: formData.date,  // ✅ Ensure date updates correctly
                extendedProps: {
                    time: formData.time,
                    priority: formData.priority,
                    notes: formData.notes
                }
            });
        } else {
            alert('Error updating event: ' + JSON.stringify(data.errors || data.error));
        }
    })
    .catch(error => console.error("AJAX Error:", error));
}
</script>
{% endblock %}
